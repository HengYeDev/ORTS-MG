trigger: 
  branches:
    include:
    - Core
  paths:
    exclude: # file paths which will not trigger a build
    - Build/*

jobs:
- job: GetVersionJob
  pool:
    vmImage: 'windows-latest'
  steps:
  - checkout: self
    fetchDepth: 10 

  - task: PowerShell@2
    displayName: Get the version from directory.builds.props
    name: SetVersionTask
    inputs:
      targetType: 'inline'
      script: |
        [string] $version = (Select-Xml -Path Source\Directory.Build.props -XPath "/Project/PropertyGroup/VersionPrefix").Node.InnerText
        Write-Host "Updating the value of the codeVersion to '$version'."
        Write-Host "##vso[task.setvariable variable=versionFromCode;isOutput=true;]$version";

  - task: PowerShell@2
    displayName: Show the version
    inputs:
      targetType: 'inline'
      script: |
        Write-Host "Current versionFromCode is '$(SetVersionTask.versionFromCode)'."

- job: Build
  dependsOn: GetVersionJob
  pool:
    vmImage: 'windows-latest'

  variables:
    solution: 'Source/Orts.sln'
    buildPlatform: 'Any CPU'
    buildConfiguration: 'Release'
    versionFromCode: $[dependencies.GetVersionJob.outputs['SetVersionTask.versionFromCode']]
    counterName: '$(channel)$(versionFromCode)'
    buildNumber: $[counter(variables['counterName'], 0)]
    versionSuffix: '$(channel).$(buildNumber)+$(tag)'
    version: '$(versionFromCode)-$(versionSuffix)'
    githubUrl: 'https://github.com/perpetualKid/ORTS-MG/commit/'
    downloadurl: 'https://ultimaterails.blob.core.windows.net'
    containerName: 'builds'
    versionJson: 'version.json'

  steps:
  - checkout: self
#    fetchDepth: 20 

  - task: NuGetToolInstaller@1

  - task: NuGetCommand@2
    inputs:
      restoreSolution: '$(solution)'

  - task: PowerShell@2
    displayName: Set the name of the build
    inputs:
      targetType: 'inline'
      script: |
        Write-Host "Setting the name of the build to '$(version)'."
        Write-Host "##vso[build.updatebuildnumber]$(version)"
        $html = git log --pretty=format:"%h|%ad|%an|%s" --date=format:"%Y-%m-%d %H:%M" -100 `
        | ConvertFrom-Csv -Delimiter "|" -Header "Commit", "Date", "Author", "Message" `
        | ConvertTo-Html -title "Commit History" `
        -Head "Open Rails Commit History Channel=$(channel) Version=$(version)" `
        -Property @{Label="Link";Expression={"<a href='$(githubUrl)$($_.Commit)'>$($_.Commit)</a>"}}, Date, Author, Message
        [System.Net.WebUtility]::HtmlDecode($html) | Out-File $(Build.ArtifactStagingDirectory)/history.html

  - task: PowerShell@2
    displayName: Create channel versions table and log
    inputs:
      targetType: 'inline'
      script: |
        $versionTable = ''
        try 
        { 
          $versionTableString = (new-object System.Net.WebClient).DownloadData('$(downloadurl)/$(containerName)/$(versionJson)')
          $versionTableString = [System.Text.Encoding]::Unicode.GetString($versionTableString)
          $versionTable = $versionTableString.TrimStart([char]65279) | ConvertFrom-Json
        }
        catch { $versionTable  = [PSCustomObject]@{ "channels" = @()}}
        $release = $versionTable.channels | where {$_.name -eq '$(channel)'}
        $date = get-date
        $date = $date.AddTicks(-$date.Ticks % [TimeSpan]::TicksPerSecond)
        $date = $date.ToUniversalTime().ToString("o")
        if ($release -ne $null)
        {
          $release.date = $date
          $release.version = $(version1)
        }
        else          
        { 
          $release = [PSCustomObject]@{name ='$(channel)'; date = $date; url = '$(downloadurl)/$(containerName)/$(channel)/(versionFromCode)/$(version).zip'; version = '$(version)'}
          $versionTable.channels += $release
        }
        $json = $versionTable | ConvertTo-Json -Depth 8
        $json | Out-File $(Build.ArtifactStagingDirectory)/$(versionJson)

  - task: MSBuild@1
    displayName: Building the solution
    inputs:
      solution: '$(solution)'
      msbuildArchitecture: 'x64'
      platform: '$(buildPlatform)'
      configuration: '$(buildConfiguration)'
      msbuildArguments: '-property:versionsuffix=$(versionSuffix)'
  
  - task: VSTest@2
    displayName: Testing the solution
    inputs:
      platform: '$(buildPlatform)'
      configuration: '$(buildConfiguration)'

  - task: ArchiveFiles@2
    displayName: Creating zip archive
    inputs:
      rootFolderOrFile: './Program.Core/'
      includeRootFolder: true 
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)/$(version).zip'
      replaceExistingArchive: true

  - task: AzureFileCopy@3
    displayName: Uploading the binaries to Azure
    inputs:
      SourcePath: '$(Build.ArtifactStagingDirectory)/$(version).zip'
      ConnectedServiceNameARM: 'Visual Studio Enterprise(81c98ddc-0e66-422e-af90-10337e5c2352)'
      Destination: 'AzureBlob'
      StorageAccountRM: 'ultimaterails'
      ContainerName: '$(container)'
      BlobPrefix: '$(channel)/$(versionFromCode)'

  - task: AzureFileCopy@3
    displayName: Uploading history logs to Azure
    inputs:
      SourcePath: '$(Build.ArtifactStagingDirectory)'
      ConnectedServiceNameARM: 'Visual Studio Enterprise(81c98ddc-0e66-422e-af90-10337e5c2352)'
      Destination: 'AzureBlob'
      StorageAccountRM: 'ultimaterails'
      ContainerName: '$(container)'
      BlobPrefix: '$(channel)'
      additionalArgumentsForBlobCopy: '/Pattern:*.html /Y /SetContentType:text/html'

  - task: AzureFileCopy@3
    displayName: Uploading version table to Azure
    inputs:
      SourcePath: '$(Build.ArtifactStagingDirectory)'
      ConnectedServiceNameARM: 'Visual Studio Enterprise(81c98ddc-0e66-422e-af90-10337e5c2352)'
      Destination: 'AzureBlob'
      StorageAccountRM: 'ultimaterails'
      ContainerName: '$(container)'
      additionalArgumentsForBlobCopy: '/Pattern:$(versionJson) /Y /SetContentType:application/json'